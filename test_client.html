<!DOCTYPE html>
<html>
<head>
    <title>Test Image API</title>
</head>
<body>
    <h1>Test Image Upload API</h1>
    
    <div>
        <h3>Subir imagen desde archivo:</h3>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">Subir Imagen</button>
    </div>
    
    <div>
        <h3>Obtener imagen por ID:</h3>
        <input type="number" id="imageId" placeholder="ID de imagen">
        <button onclick="getImage()">Obtener Imagen</button>
    </div>
    
    <div id="result"></div>

    <script>
        const API_BASE = 'http://0.0.0.1:8025';

        // Función para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remover el prefijo "data:image/...;base64,"
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        // Subir imagen
        async function uploadImage() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona una imagen');
                return;
            }

            try {
                const base64 = await fileToBase64(file);
                
                const response = await fetch(`${API_BASE}/images/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_data: base64
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').innerHTML = 
                        `<p style="color: green;">✅ Imagen subida! ID: ${result.id}</p>`;
                } else {
                    document.getElementById('result').innerHTML = 
                        `<p style="color: red;">❌ Error: ${result.detail}</p>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = 
                    `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }

        // Obtener imagen
        async function getImage() {
            const imageId = document.getElementById('imageId').value;
            
            if (!imageId) {
                alert('Por favor ingresa un ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/images/${imageId}`);
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').innerHTML = `
                        <div style="color: green;">
                            <h4>✅ Imagen encontrada:</h4>
                            <p>ID: ${result.id}</p>
                            <p>Fecha: ${result.created_at}</p>
                            <p>Tamaño: ${result.image_data.length} caracteres</p>
                            <img src="data:image/png;base64,${result.image_data}" 
                                 style="max-width: 200px; border: 1px solid #ccc;">
                        </div>
                    `;
                } else {
                    document.getElementById('result').innerHTML = 
                        `<p style="color: red;">❌ Error: ${result.detail}</p>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = 
                    `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>